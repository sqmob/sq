<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobitel Speed Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
            padding: 20px;
            background-image: url('https://www.ipinternational.net/wp-content/uploads/2021/11/iStock-1274394138-1.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: white;
        }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        table { margin-top: 20px; width: 50%; margin-left: auto; margin-right: auto; border-collapse: collapse; background-color: rgba(0, 0, 0, 0.7); }
        th, td { border: 1px solid white; padding: 10px; text-align: center; }
        canvas { margin-top: 20px; width: 100%; max-width: 600px; background-color: rgba(0, 0, 0, 0.7); }
        h2 { background-color: rgba(0, 0, 0, 0.7); padding: 10px; display: inline-block; }
    </style>
</head>
<body>
    <h2>SQ Speed Testing</h2>
    <button onclick="testSpeed('https://proof.ovh.net/files/100Mb.dat', 1000, 'result1')">Test Speed - France</button>
    <button onclick="testSpeed('http://2uqualservsweb.com/100M.bin', 10000, 'result2')">Test Speed - USA</button>
    <button onclick="testSpeed('http://2aqualservsweb.com/100M.bin', 10000, 'result3')">Test Speed - Asia</button>
    <button onclick="testSpeed('http://speedtest.singapore.linode.com/100MB-singapore.bin', 100, 'result4')">Test Speed - Singapore</button>
    <button onclick="testSpeed('http://172.22.15.54/files/100MB.zip', 1000, 'result5')">Local Speed Testing</button>
    <button onclick="stopTest()">ðŸ›‘ Stop Test</button>
    
    <canvas id="speedChart"></canvas>
    
    <script>
        let speedChart = new Chart(document.getElementById('speedChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Download Speed (Mbps)',
                    data: [],
                    borderColor: 'blue',
                    borderWidth: 2,
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { title: { display: true, text: 'Time (s)' } },
                    y: { title: { display: true, text: 'Speed (Mbps)' } }
                }
            }
        });

        let controller;
        let currentSpeedRecords = [];

        async function testSpeed(fileUrl, fileSizeMB, resultId) {
            stopTest();
            controller = new AbortController();
            let signal = controller.signal;

            currentSpeedRecords = [];

            try {
                let response = await fetch(fileUrl, { signal });
                if (!response.body) throw new Error("ReadableStream not supported");

                let reader = response.body.getReader();
                let startTime = performance.now();
                let receivedBytes = 0;
                let timestamps = [];

                async function readChunks() {
                    let { done, value } = await reader.read();
                    if (done) return;

                    receivedBytes += value.length;
                    let currentTime = (performance.now() - startTime) / 1000;
                    let speedMbps = (receivedBytes * 8) / (currentTime * 1024 * 1024);
                    
                    currentSpeedRecords.push(speedMbps);
                    timestamps.push(currentTime.toFixed(2));

                    speedChart.data.labels = timestamps;
                    speedChart.data.datasets[0].data = currentSpeedRecords;
                    speedChart.update();

                    return readChunks();
                }
                await readChunks();
            } catch (error) {
                if (error.name !== "AbortError") {
                    alert(`Error: ${error.message}`);
                }
            }
        }

        function stopTest() {
            if (controller) {
                controller.abort();
                controller = null;
                console.log("Speed test aborted.");
            }
        }
    </script>
</body>
</html>
