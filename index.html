<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Download Speed Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #chartContainer {
            width: 80%;
            margin: 20px auto;
        }
        table {
            width: 50%;
            margin: 20px auto;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>local Speed Monitor</h1>
    <button id="startDownload">Start Download</button>
    <button id="stopDownload" disabled>Stop Download</button>
    <div id="chartContainer">
        <canvas id="speedChart"></canvas>
    </div>
    <table>
        <thead>
            <tr>
                <th>Metric</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Average Speed</td>
                <td id="averageSpeed">0 Mbps</td>
            </tr>
            <tr>
                <td>Maximum Speed</td>
                <td id="maxSpeed">0 Mbps</td>
            </tr>
        </tbody>
    </table>

    <script>
        let downloadStartTime;
        let downloadInterval;
        let stopDownload = false;
        let speeds = [];
        let chart;
        let ctx = document.getElementById('speedChart').getContext('2d');

        // Initialize Chart.js
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Time labels
                datasets: [{
                    label: 'Download Speed (Mbps)',
                    data: [], // Speed data
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Time (seconds)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Speed (Mbps)'
                        }
                    }
                }
            }
        });

        // Function to calculate speed in Mbps
        function calculateSpeed(bytes, seconds) {
            return (bytes / 1024 / 1024) / seconds * 8; // Convert to Mbps
        }

        // Function to update the chart and table
        function updateChartAndTable(timeElapsed, speed) {
            // Update chart
            chart.data.labels.push(timeElapsed.toFixed(2));
            chart.data.datasets[0].data.push(speed);
            chart.update();

            // Update table
            const averageSpeed = (speeds.reduce((a, b) => a + b, 0) / speeds.length) || 0;
            const maxSpeed = Math.max(...speeds, 0);

            document.getElementById('averageSpeed').textContent = `${averageSpeed.toFixed(2)} Mbps`;
            document.getElementById('maxSpeed').textContent = `${maxSpeed.toFixed(2)} Mbps`;
        }

        // Start download
        document.getElementById('startDownload').addEventListener('click', async () => {
            stopDownload = false;
            speeds = [];
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            chart.update();

            document.getElementById('startDownload').disabled = true;
            document.getElementById('stopDownload').disabled = false;

            downloadStartTime = Date.now();
            try {
                const proxyUrl = "https://api.codetabs.com/v1/proxy/?quest=";
                const fileUrl = proxyUrl + encodeURIComponent("http://172.22.15.54/files/100MB.zip");

                const response = await fetch(fileUrl);
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                const reader = response.body.getReader();
                let receivedLength = 0;

                downloadInterval = setInterval(() => {
                    const timeElapsed = (Date.now() - downloadStartTime) / 1000;
                    const speed = calculateSpeed(receivedLength, timeElapsed);
                    speeds.push(speed);
                    updateChartAndTable(timeElapsed, speed);
                }, 1000);

                while (true) {
                    if (stopDownload) {
                        clearInterval(downloadInterval);
                        reader.cancel();
                        break;
                    }

                    const { done, value } = await reader.read();
                    if (done) {
                        clearInterval(downloadInterval);
                        break;
                    }

                    receivedLength += value.length;
                }
            } catch (error) {
                console.error('Download failed:', error);
                alert('Download failed. Check the console for details.');
            } finally {
                document.getElementById('startDownload').disabled = false;
                document.getElementById('stopDownload').disabled = true;
            }
        });

        // Stop download
        document.getElementById('stopDownload').addEventListener('click', () => {
            stopDownload = true;
        });
    </script>
</body>
</html>
